<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>EditModel/event-program/data-entry-form/dataEntryFormUtils.js - Postman Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addPropsToFieldConfig">addPropsToFieldConfig</a></li><li><a href="global.html#addQuery">addQuery</a></li><li><a href="global.html#BEFORE_START_OF_REPORTING_PERIOD">BEFORE_START_OF_REPORTING_PERIOD</a></li><li><a href="global.html#bindFuncsToKeys">bindFuncsToKeys</a></li><li><a href="global.html#branchWithMessage">branchWithMessage</a></li><li><a href="global.html#cloneHandlerByObjectType">cloneHandlerByObjectType</a></li><li><a href="global.html#constantNameConverter">constantNameConverter</a></li><li><a href="global.html#createFieldConfigsFor">createFieldConfigsFor</a></li><li><a href="global.html#createModelToEditEpic">createModelToEditEpic</a></li><li><a href="global.html#createStepperContentFromConfig">createStepperContentFromConfig</a></li><li><a href="global.html#createStepperFromConfig">createStepperFromConfig</a></li><li><a href="global.html#deleteProgramStageFromState">deleteProgramStageFromState</a></li><li><a href="global.html#findHelpLinkForPath">findHelpLinkForPath</a></li><li><a href="global.html#getDocsVersion">getDocsVersion</a></li><li><a href="global.html#getFieldInfoFromMatch">getFieldInfoFromMatch</a></li><li><a href="global.html#getProgramStageDataElementsByStageId">getProgramStageDataElementsByStageId</a></li><li><a href="global.html#getProgramStageFromModel">getProgramStageFromModel</a></li><li><a href="global.html#removeQuery">removeQuery</a></li><li><a href="global.html#replaceMappingPathPlaceholder">replaceMappingPathPlaceholder</a></li><li><a href="global.html#replacePlaceholder">replacePlaceholder</a></li><li><a href="global.html#ReportDateToUseDropDown">ReportDateToUseDropDown</a></li><li><a href="global.html#setEditModel">setEditModel</a></li><li><a href="global.html#sharedOverrides">sharedOverrides</a></li><li><a href="global.html#tetAttributesNotInProgram">tetAttributesNotInProgram</a></li><li><a href="global.html#typeDetails">typeDetails</a></li><li><a href="global.html#withProgramAndStages">withProgramAndStages</a></li><li><a href="global.html#withProgramStageFromProgramStage$">withProgramStageFromProgramStage$</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">EditModel/event-program/data-entry-form/dataEntryFormUtils.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import log from 'loglevel';

const inputPattern = /&lt;input.*?\/>/gi;

/* AttributeIdPattern is used in tracker-programs Custom registration forms
   programIdPattern is used in tracker-programs Custom registration forms
        Fixed to incidentDate and enrollmentDate
* id is used for combined-ids:
*   - Event-programs data entry form (dataElementId-categoryOptionId)
*   - Tracker-programs Data entry form (programStageId-dataElementId)*/
export const elementPatterns = {
    programid: /attributeid="(\w*?)"/,
    attributeid: /programid="(\w*?)"/,
    id: /id="(\w*?)-(\w*?)-val"/
}

//When matching with exec, match[0] will be idString, including the ID. Ie: attributeid="someid"
const allPatterns = /attributeid="(\w*?)"|programid="(\w*?)"|id="((\w*?)-(\w*?)-val)"/

//Map over the position of the match of the pattern in the allPattern.
//matchIndexes[attributeid] will be the id of the element matched.
const matchIndexes = {
    'attributeid': 1,
    'programid': 2,
    'id': 3,
}

export function generateHtmlForField(id, styleAttr, disabledAttr, label, nameAttr = "entryfield", fieldType='id') {
    const style = styleAttr ? ` style=${styleAttr}` : '';
    const disabled = disabledAttr ? ` disabled=${disabledAttr}` : '';

    const attr = `name="${nameAttr}" title="${label}" value="[ ${label} ]"${style}${disabled}`.trim();
    return `&lt;input ${fieldType}="${id}" ${attr}/>`;

}

/* Operands with ID's that contain a dot ('.') are a combined IDs of two objects.
 The API returns ie. "dataElementId.categoryOptionId", which are transformed to the format expected by
 custom forms: "dataElementId-categoryOptionId-val"
    This is used for programStageId-dataElementId for Tracker-programs.
    And dataElementId-categoryOptionId for event-programs
 */
export function transformElementsToCustomForm(elements) {
    elements
        .filter(op => op.id.indexOf('.') !== -1)
        .reduce((out, op) => {
            const id = `${op.id.split('.').join('-')}-val`;
            out[id] = op.displayName; // eslint-disable-line
            return out;
        }, {});
}


/**
 * Gets the id and idString from a matched element.
 *
 *  The idString is the entire string to be used as a html-attribute.
 *  Ie. attributeid="IpHINAT79UW"
 *  The id is then "IpHINAT79UW".
 *
 * @param match the Regex-match object to use
 * @returns {*} an object with idString, id and fieldType of the element.
 */
function getFieldInfoFromMatch(match) {
    for(let patternId in matchIndexes) {
        const index = matchIndexes[patternId];
        const elemId = match[index];
        if(elemId) {
            let id = elemId;
            return {
                idString: match[0],
                id,
                fieldType: patternId
            }
        }
    }
    return null;
}

export function processFormData(formData, elements, idPattern) {
    const inHtml = formData;
    let outHtml = '';

    const usedIds = [];
    idPattern = elementPatterns.attributeid
    let inputElement = inputPattern.exec(inHtml);
    let inPos = 0;
    while (inputElement !== null) {
        outHtml += inHtml.substr(inPos, inputElement.index - inPos);
        inPos = inputPattern.lastIndex;
        const inputHtml = inputElement[0];
        const inputStyle = (/style="(.*?)"/.exec(inputHtml) || ['', ''])[1];
        const inputDisabled = /disabled/.exec(inputHtml) !== null;

        const allMatch = allPatterns.exec(inputHtml);
        const {Â idString, id, fieldType} = getFieldInfoFromMatch(allMatch)

        if (idString &amp;&amp; id) {
         //   console.log(idMatch);
            usedIds.push(id);
            const label = elements &amp;&amp; elements[id];
            outHtml += generateHtmlForField(id, inputStyle, inputDisabled, label, undefined, fieldType);
        } else {
            outHtml += inputHtml;
        }

        inputElement = inputPattern.exec(inHtml);
    }
    outHtml += inHtml.substr(inPos);
    //console.log(outHtml)
    return {
        usedIds,
        outHtml
    }
}

/**
 * Helper to bind the keys of an object to given function
 * So that multiple elements can be bound to the same function.
 * The first parameter of each bound function will be the key.
 * @param obj Object with keys to bind
 * @param func Function to bind each key to
 * @param selfArg this context of the function
 * @param extraArgs An object of extra arguments
 * @returns {{}} - And object where each property is a bound function
 */
export function bindFuncsToKeys(obj, func, selfArg, extraArgs) {
    const boundFuncs = {};
    Object.keys(obj).forEach((x) => {
        boundFuncs[x] = func.bind(selfArg, x, extraArgs);
    });
    return boundFuncs;
}

export function insertElement(id, label, editor, fieldType = 'id') {
    const elementHtml = generateHtmlForField(id, null, null, label, undefined, fieldType);
    editor.insertHtml(elementHtml, 'unfiltered_html');
    // Move the current selection to just after the newly inserted element
    const range = editor.getSelection().getRanges()[0];
    range &amp;&amp; range.moveToElementEditablePosition(range.endContainer, true);
}

export function insertFlag(img, editor) {
    editor.insertHtml(`&lt;img src="../dhis-web-commons/flags/${img}" />`, 'unfiltered_html');
    const range = editor.getSelection().getRanges()[0];
    range &amp;&amp; range.moveToElementEditablePosition(range.endContainer, true);
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated at Tue Apr 24 2018 15:50:26 GMT+0000 (UTC)
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
